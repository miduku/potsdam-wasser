/*!
 * Potsdamwasser
 * Analyse und Visualisierung des Wasserversorgungsnetzes Potsdams
 * https://incom.org/workspace/6224/2
 * @author Dustin Kummer
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
!function(t,e){"use strict";var n=function(){function e(t){var e,n,s=t.offsetHeight;if(a)r=a();else for(var o in i)e=o,document.body.clientWidth>e&&e>=n&&(r=i[o],n=e);t.style.marginBottom=r-s%r+"px"}function n(n){e(n),"addEventListener"in t?t.addEventListener("resize",function(){e(n)},!1):"attachEvent"in t&&t.attachEvent("resize",function(){e(n)})}var a,r=0,i={};return function(t,e){var s="string"==typeof t?document.querySelectorAll(t):t,o=s.length;if("number"==typeof e)r=parseInt(e,10);else if("function"==typeof e)a=e;else if("object"==typeof e){var l=parseInt(getComputedStyle(document.body,null).getPropertyValue("font-size"),10);for(var c in i){var d=/\d+em/.test(c)?parseInt(c,10)*l:/\d+px/.test(c)?parseInt(c,10):c;i[d]=parseInt(i[c],10)}}if(o>1)for(;o--;)n(s[o]);else n(s[0])}}();"undefined"!=typeof e?e.extend(e.fn,{baseline:function(t){return n(this,t)}}):t.baseline=n}(window,window.jQuery||window.Zepto||void 0),function(t,e,n,a,r){"use strict";function i(){h.navMain._this.children("ul").children("li").find("span").css({width:function(){return h.navContainer.outerWidth()-t(this).parent().outerWidth()}})}function s(){h.wide.each(function(e,n){var a=t(n),r={_this:a.find(".icon i"),size:a.find(".icon i").outerWidth()},i={posTop:r._this.position().top,posLeft:r._this.offset().left,size:function(){return a.outerWidth()>a.outerHeight()?a.outerWidth():a.outerHeight()}};a.children(".flood").children(".circle").css({top:i.posTop+r.size/2-i.size(),left:i.posLeft+r.size/2-i.size(),width:2*i.size(),height:2*i.size()})})}function o(){var t=h.wideFooter,e=h.main.children("section").find(".waterpipe").last(),n={posLeft:e.offset().left+e.outerWidth()/2,size:function(){return t.outerWidth()>t.outerHeight()?t.outerWidth():t.outerHeight()}};t.children(".flood").children(".circle").css({top:0-n.size(),left:n.posLeft-n.size(),width:2*n.size(),height:2*n.size()})}function l(){h.navMain._this.not(".hidden").children("ul").find("i").each(function(e,n){e<v.iconPositionsArr.navIcons.length-1&&t(n).children(".waterpipeNav").css("height",c(v.iconPositionsArr.navIcons[e],v.iconPositionsArr.navIcons[e+1]))})}function c(t,e){return e.offset().top-t.offset().top-t.outerHeight()}function d(t,e){return e.offset().top-t.offset().top}function u(e,n,a,r,i){"undefined"!==i&&null!==i||(i=!1),h.win.outerWidth()>=n?e.removeClass(a[0]).addClass(a[1]).css({left:a[2]}):e.removeClass(r[0]).addClass(r[1]).css({left:r[2]}),i&&t(".click-overlay").removeClass("visible")}function g(t){var n=t.w,a=t.h,r=Math.min(n,a)/2,i=e.scaleOrdinal().range(t.colors),s=e.arc().outerRadius(r-50).innerRadius(0),o=e.arc().outerRadius(r-10).innerRadius(r-10),l=e.select(t.element).append("svg").attr("class","d3PieChart").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+n+" "+a).append("g").attr("class","g").attr("transform","translate("+.5*n+","+.5*a+")"),c=e.pie().sort(null).value(function(e){return e[t.dataValueString]});e.csv(t.data,t.dataType,function(e,n){if(e)throw e;l.append("g").attr("class","arcs"),l.append("g").attr("class","labels"),l.append("g").attr("class","lines");var a=l.select(".arcs").selectAll(".arc").data(c(n)).enter();a.append("path").attr("class","arc").attr("d",s).style("stroke","#ffffff").style("stroke-linejoin","round").style("stroke-width",2).style("fill",function(e){return i(e.data[t.dataKeyString])});var r=l.select(".labels").selectAll(".label").data(c(n)).enter();r.append("text").attr("class","label").attr("dy",".35em").attr("text-anchor","middle").attr("transform",function(t){return"translate("+o.centroid(t)+")"}).style("font-size","1.25em").text(function(e){return e.data[t.dataKeyString]+": "+e.data[t.dataValueString]});var d=l.select(".lines").selectAll(".line").data(c(n)).enter();d.append("circle").attr("class","lineCircle").attr("x",0).attr("y",0).attr("r",3).attr("transform",function(t){return"translate("+s.centroid(t)+")"}),d.append("line").attr("class","line").attr("stroke-width",1).attr("x1",function(t){return s.centroid(t)[0]}).attr("y1",function(t){return s.centroid(t)[1]}).attr("x2",function(t){return.93*o.centroid(t)[0]}).attr("y2",function(t){return.93*o.centroid(t)[1]})})}function f(n){var a=n.element,r=n.w,i=n.h,s=r-n.margin.left-n.margin.right,o=i-n.margin.top-n.margin.bottom,l=e.scaleBand().rangeRound([0,s]).padding(.1),c=e.scaleLinear().rangeRound([o,0]),d=e.select(a).append("svg").attr("class","d3BarChart").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+r+" "+i).append("g").attr("class","g").attr("transform","translate("+n.margin.left+","+n.margin.top+")");e.csv(n.data,n.dataType,function(r,i){if(r)throw r;l.domain(i.map(function(t){return t[n.dataSets[0]]})),c.domain([0,e.max(i,function(t){return t[n.dataSets[1]]})]),d.append("g").attr("class","axis"),d.append("g").attr("class","bars"),d.append("g").attr("class","labels"),d.select(".axis").append("g").attr("class","axis-x").attr("transform","translate(0, "+o+")").call(e.axisBottom(l)),d.select(".axis").append("g").attr("class","axis-y").call(e.axisLeft(c).ticks(10)).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").style("font-style","italic").text(n.yAxisLabel);var s=d.select(".bars").selectAll(".bar").data(i).enter();s.append("rect").attr("class","bar").attr("x",function(t){return l(t[n.dataSets[0]])}).attr("y",function(t){return c(t[n.dataSets[1]])}).attr("width",l.bandwidth()).attr("height",function(t){return o-c(t[n.dataSets[1]])}),e.selectAll(a+" .bar").each(function(e,a){t(this).attr("fill",function(){return"Potsdam"===e[n.dataSets[0]]?n.colors[1]:n.colors[0]})});var u=d.select(".labels").selectAll(".label").data(i).enter();u.append("text").attr("class","label").attr("dy",".35em").attr("text-anchor","middle").attr("transform","translate(0, -10)").attr("x",function(t){return l(t[n.dataSets[0]])+l.bandwidth()/2}).attr("y",function(t){return c(t[n.dataSets[1]])}).text(function(t){return t[n.dataSets[1]]})})}function p(n,a){var r=n.element,i=n.h,s=n.w,o=i-n.margin.left-n.margin.right,l=s-n.margin.top-n.margin.bottom,c=e.scaleTime().range([0,l]),d=e.scaleLinear().range([o,0]),u=e.scaleOrdinal().range(n.colors),g=e.select(r).append("svg").attr("class","d3MultiLineChart").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+s+" "+i).append("g").attr("class","g").attr("transform","translate("+n.margin.left+","+n.margin.top+")"),f=e.line().defined(function(t){return null!==t.liter}).curve(n.curveType).x(function(t){return c(t.date)}).y(function(t){return d(t.liter)});e.csv(n.data,n.dataType,function(i,s){if(i)throw i;var p=s.columns.slice(1).map(function(t){return{id:t,values:s.map(function(e){return{date:e.Jahr,liter:e[t]}})}});c.domain(e.extent(s,function(t){return t.Jahr})),d.domain([e.min(p,function(t){return e.min(t.values,function(t){return t.liter})}),e.max(p,function(t){return e.max(t.values,function(t){return t.liter})})]),u.domain(p.map(function(t){return t.id})),g.append("g").attr("class","axis"),g.append("g").attr("class","lines"),g.append("g").attr("class","labels"),g.append("g").attr("class","mouseovers"),g.select(".axis").append("g").attr("class","grid-x").attr("transform","translate(0,"+o+")").style("opacity","0.15").call(e.axisBottom(c).ticks(10).tickSize(-o).tickFormat("")),g.select(".axis").append("g").attr("class","grid-y").style("opacity","0.15").call(e.axisLeft(d).ticks(20).tickSize(-l).tickFormat("")),g.select(".axis").append("g").attr("class","axis-x").attr("transform","translate(0, "+o+")").call(e.axisBottom().scale(c).ticks(12)),g.select(".axis").append("g").attr("class","axis-y").call(e.axisLeft().scale(d).ticks(null,"s")).append("text").attr("transform","rotate(-90)").attr("y",16).attr("dy","0.32em").style("font-style","italic").text(n.yAxisLabel);var h=g.select(".lines").selectAll(".line").data(p).enter();if(h.append("path").attr("class",function(t){return"line line"+t.id}).attr("d",function(t){return f(t.values)}).style("fill","none").style("stroke-width",2).style("stroke",function(t){return u(t.id)}),a){console.log("showing Dots");var v=g.select(".lines").selectAll(".dots").data(p).enter(),m=v.append("g").attr("class",function(t){return"dots dots"+t.id}).selectAll("circle").data(function(t){return t.values}).enter();m.append("circle").attr("cx",function(t){return c(t.date)}).attr("cy",function(t){return d(null!==t.liter?t.liter:"0")}).attr("r",function(t){return null!==t.liter?"2":"0"}).style("stroke","none")}var y=g.select(".labels").selectAll(".label").data(p).enter();y.append("text").datum(function(t){return{id:t.id,value:t.values[t.values.length-1]}}).attr("class","label").attr("transform",function(t){return"translate("+c(t.value.date)+", "+d(t.value.liter)+") rotate(15)"}).attr("x",3).attr("dy","0.35em").style("font-size","1.1em").text(function(t){return t.id}),g.select(".mouseovers").append("path").attr("class","mouseLine").style("stroke","#737373").style("stroke-width",1).style("opacity","0");var w=t(r+" .line"),x=g.select(".mouseovers").selectAll(".mousePerLine").data(p).enter().append("g").attr("class","mousePerLine");x.append("circle").attr("class","moCircle").attr("r",4).style("fill",function(t){return u(t.id)}).style("opacity","0"),x.append("rect").attr("class","moLabelBackground").style("fill","#fff"),x.append("text").attr("class","moText").style("font-size","1em");var b=t(r+" .moText"),k=e.range(b.length).map(function(){return{padding:1,boxHeight:20,translateX:10,translateY:3}});g.select(".mouseovers").append("rect").attr("width",l).attr("height",o).attr("pointer-events","all").style("fill","none").on("mouseout",function(){e.select(r+" .mouseLine").style("opacity","0"),e.selectAll(r+" .mousePerLine circle").style("opacity","0"),e.selectAll(r+" .mousePerLine rect").style("opacity","0"),e.selectAll(r+" .mousePerLine text").style("opacity","0")}).on("mouseover",function(){e.select(r+" .mouseLine").style("opacity","1"),e.selectAll(r+" .mousePerLine circle").style("opacity","1"),e.selectAll(r+" .mousePerLine rect").style("opacity","0.75"),e.selectAll(r+" .mousePerLine text").style("opacity","1")}).on("mousemove",function(){var n=e.mouse(this);e.selectAll(r+" .moText").each(function(e,n){t(this).attr("transform","translate("+k[n].translateX+","+k[n].translateY+")"),k[n].boxWidth=1.5*t(this).outerWidth()}),e.selectAll(r+" .moLabelBackground").each(function(e,n){t(this).attr("transform","translate("+(k[n].translateX-k[n].padding)+","+-4*k[n].translateY+")").attr("width",k[n].boxWidth).attr("height",k[n].boxHeight)}),e.select(r+" .mouseLine").attr("d",function(){var t="M"+n[0]+","+o;return t+=" "+n[0]+",0"}),e.selectAll(r+" .mousePerLine").attr("transform",function(t,a){for(var r=0,i=w[a].getTotalLength(),s=null,o=null;s=Math.floor((r+i)/2),o=w[a].getPointAtLength(s),s!==i&&s!==r||o.x===n[0];)if(o.x>n[0])i=s;else{if(!(o.x<n[0]))break;r=s}return e.select(this).select("text").text(d.invert(o.y).toFixed(0)),"translate("+n[0]+","+o.y+")"})})})}var h={win:t(n),bod:t("body"),navContainer:t(".nav-container"),wide:t("main .wide"),wideFooter:t("footer .wide"),main:t("main"),navMain:{_this:t(".nav-main"),a:t(".nav-main a"),icon:{_this:t(".nav-main ul i"),gewinnung:t(".nav-main-gewinnung i"),versorgung:t(".nav-main-versorgung i"),reinigung:t(".nav-main-reinigung i"),natur:t(".nav-main-natur i"),last:t(".nav-main-last i")}},section:{intro:t("#section-intro"),natur:t("#section-natur")},icon:{_this:t(".container .icon i"),gewinnung:t("#section-gewinnung .icon i"),versorgung:t("#section-versorgung .icon i"),reinigung:t("#section-reinigung .icon i"),natur:t("#section-natur .icon i")},footer:{_this:t("footer")}},v={iconPositionsArr:{mainIcons:[h.icon.natur,h.icon.gewinnung,h.icon.versorgung,h.icon.reinigung,h.footer._this],navIcons:[h.navMain.icon.natur,h.navMain.icon.gewinnung,h.navMain.icon.versorgung,h.navMain.icon.reinigung,h.navMain.icon.last]},colors:{gewinnung:[40,137,179],versorgung:[56,115,184],reinigung:[130,154,175],natur:[46,156,204]},offset:{fromTop:.75}},m="webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",y={wVerteilung:{element:"#d3Verteilung > .d3",w:800,h:470,colors:["#3873B8","#2889B3","#2E9CCC","#829AAF"],data:"assets/data/taeglicher-gesamt-wasserbedarf-potsdams.csv",dataType:function(t){return t.Liter=+t.Liter,t},dataKeyString:"Kategorie",dataValueString:"Liter"},wFoerderkapazitaet:{element:"#d3Foerderkapazitaet > .d3",w:850,h:470,colors:["#3873B8","#2889B3","#2E9CCC","#829AAF","#f44336"],data:"assets/data/foerderkapazitaet-wasserwerke-potsdam.csv",dataType:function(t){return t["Fördermenge in Kubikmeter"]=+t["Fördermenge in Kubikmeter"],t},dataKeyString:"Wasserwerk",dataValueString:"Fördermenge in Kubikmeter"},wVerbrauch:{element:"#d3Verbrauch > .d3",w:800,h:490,margin:{top:20,right:40,bottom:20,left:50},colors:["#3873B8","#f44336","#2889B3","#2E9CCC","#829AAF"],data:"assets/data/wasserverbrauch-proportianal-bevoelkerungsdichte.csv",dataType:function(t,n,a){var r=e.timeParse("%Y");t.Jahr=r(t.Jahr);for(var i,s=1,o=a.length;s<o;++s)t[i=a[s]]=+t[i];return t},curveType:e.curveStep,yAxisLabel:"Liter"},wAbgabe:{element:"#d3Wasserabgabe > .d3",w:800,h:470,margin:{top:20,right:0,bottom:120,left:50},colors:["#3873B8","#f44336","#2889B3","#2E9CCC","#829AAF"],data:"assets/data/wasserabgabe-versorgungsgebiet-potsdam-einwohner.csv",dataType:function(t,n,a){var r=e.timeParse("%Y");t.Jahr=r(t.Jahr);for(var i,s=1,o=a.length;s<o;++s)t[i=a[s]]="NaN"!==t[i]?+t[i]:null;return t},curveType:e.curveLinear,yAxisLabel:"m³/Tag"},wVerbrauch2:{element:"#d3Verbrauch2 > .d3",w:800,h:470,margin:{top:20,right:0,bottom:40,left:50},colors:["#3873B8","#f44336"],data:"assets/data/wasserverbrauch-vergleich-partnerstaedte.csv",dataSets:["Stadt","Liter"],dataType:function(t){return t.Liter=+t.Liter,t},yAxisLabel:"Liter/Kopf"},wAuslastungsgrenze:{element:"#d3Auslastungsgrenze > .d3",w:880,h:470,margin:{top:70,right:30,bottom:40,left:60},colors:["#3873B8","#2889B3","#2E9CCC","#829AAF","#f44336"],data:"assets/data/auslastungsgrenze-wasserwerke-potsdam-einwohner-szenario2047-bevoelkerung.csv",dataSets:["Jahr (Auslastung in %)","Bevölkerung"],dataType:function(t){return t["Bevölkerung"]=+t["Bevölkerung"],t},yAxisLabel:"Bevölkerung"},wAuslastungsgrenze2:{element:"#d3Auslastungsgrenze > .d3-2",w:880,h:470,margin:{top:70,right:30,bottom:40,left:60},colors:["#3873B8","#2889B3","#2E9CCC","#829AAF","#f44336"],data:"assets/data/auslastungsgrenze-wasserwerke-potsdam-einwohner-szenario2047-foerderkapazitaet.csv",dataSets:["Jahr (Auslastung in %)","Förderkapazitäten (m³)"],dataType:function(t){return t["Bevölkerung"]=+t["Bevölkerung"],t},yAxisLabel:"Förderkapazität m³/Tag"}},w={Controller:new ScrollMagic.Controller,cast:{NavSticky:function(){return new ScrollMagic.Scene({triggerElement:"#section-intro",triggerHook:0,duration:d(h.section.intro,h.section.natur)}).addTo(w.Controller).on("progress resize",function(t){var e=t.progress;.5<=e&&e<1?u(h.navMain._this,768,["retracted hidden mobileAtTop","extended",0,!0],["retracted mobileAtTop","hidden extended",0]):1===e?u(h.navMain._this,768,["retracted mobileAtTop","hidden extended",0],["retracted mobileAtTop","hidden extended",0]):u(h.navMain._this,768,["extended hidden mobile","retracted",h.navContainer.offset().left],["","extended hidden mobileAtTop",0])})},Weather:function(){var e="#section-natur",n=t(e),a=n.find(".weather");return new ScrollMagic.Scene({triggerElement:e,triggerHook:1,duration:h.section.natur.outerHeight()}).addTo(w.Controller).on("progress leave",function(t){var e=t.progress.toFixed(1);.1<e&&e<=.9&&"leave"!==t.type?a.css("opacity",1):a.css("opacity",0)})},City:function(){var e="#section-natur",n=t(e),a=n.find(".city");return new ScrollMagic.Scene({triggerElement:e,triggerHook:1,duration:h.section.natur.outerHeight()}).addTo(w.Controller).on("progress",function(t){var e=t.progress.toFixed(2);e<1?a.css("position","fixed"):a.css("position","absolute")})},Flood:function(){var e=h.wide;return e.each(function(e,n){var a=t(n);new ScrollMagic.Scene({triggerElement:n,triggerHook:.6,duration:a.outerHeight()}).addTo(w.Controller).on("progress",function(t){var e=t.progress.toFixed(4);a.children(".flood").children(".circle").css({transform:"scale("+1.5*e+")"}),e>=.25?a.addClass("showText"):a.removeClass("showText")}).on("update leave",function(t){"leave"===t.type&&"FORWARD"===t.target.controller().info("scrollDirection")&&a.next(".container").css("opacity",1)})})},FloodFooter:function(){var e=h.wideFooter,n=t(e);new ScrollMagic.Scene({triggerElement:e,triggerHook:.6,duration:n.outerHeight()}).addTo(w.Controller).on("progress",function(t){var e=t.progress.toFixed(4);n.children(".flood").children(".circle").css({transform:"scale("+1.5*e+")"});var a=4*e;n.children(".container").css({opacity:function(){return a>1?1:a}}),e>=.25?n.addClass("showText"):n.removeClass("showText")})},Waterpipe:function(){var e=t(".waterpipe"),n=v.iconPositionsArr.mainIcons,a=[v.colors.natur,v.colors.gewinnung,v.colors.versorgung,v.colors.reinigung,v.colors.natur];return e.each(function(e,r){var i=t(r),s=[a[e+1][0]-a[e][0],a[e+1][1]-a[e][1],a[e+1][2]-a[e][2]],o=new ScrollMagic.Scene({triggerElement:r,triggerHook:v.offset.fromTop}).addTo(w.Controller).on("progress",function(t){var n=t.progress.toFixed(4),r=100*n,o=r+"%",l=r*n+"%",c=[Math.round(a[e][0]+s[0]*n),Math.round(a[e][1]+s[1]*n),Math.round(a[e][2]+s[2]*n)],d="linear-gradient(to bottom, rgb("+a[e][0]+","+a[e][1]+","+a[e][2]+") 0%, rgb("+c.join(",")+") 100%)";i.children(".water").css({background:d,height:l}),h.navMain.icon._this.eq(e).children(".waterpipeNav").children(".water").css({background:d,height:o})});h.win.on("resize",function(){o.duration(c(n[e],n[e+1])),o.refresh()})})}}};t(function(){h.icon._this.append('<div class="waterpipe"><div class="water"></div></div>'),h.navMain._this.children("ul").find("li:not(:last) i").append('<div class="waterpipeNav"><div class="water"></div></div>'),h.wide.prepend('<div class="flood"><div class="circle"></div></div>'),h.wideFooter.prepend('<div class="flood"><div class="circle"></div></div>'),h.section.natur.prepend('<div class="weather"><div class="rain"></div></div>'),h.section.natur.prepend('<div class="city"><div class="skyline"></div></div>'),h.bod.prepend('<div class="click-overlay"></div>'),h.navMain._this.prepend('<div class="click-navOverlay"></div>'),t('a[href^="#"]').bind("click.smoothscroll",function(e){e.preventDefault(),console.log("clicked",e.currentTarget.hash);var a=this.hash,r=t(a);t(".click-overlay").removeClass("visible"),t("html, body").stop().animate({scrollTop:r.offset().top},900,"swing",function(){n.location.hash=a,h.navMain._this.not(".retracted").addClass("hidden")})}),h.navMain._this.children(".click-navOverlay").on("click",function(e){e.preventDefault(),console.log("click-dots");var n=t(this).parent();n.hasClass("hidden")&&(n.removeClass("hidden").on(m,function(){l()}),t(".click-overlay").addClass("visible"))}),t(".click-overlay").on("click",function(e){e.preventDefault(),console.log("click-overlay"),t(this).removeClass("visible"),h.navMain._this.not(".retracted").addClass("hidden")}),g(y.wVerteilung),p(y.wVerbrauch),f(y.wVerbrauch2),p(y.wAbgabe,!0),g(y.wFoerderkapazitaet),f(y.wAuslastungsgrenze),f(y.wAuslastungsgrenze2),w.cast.Waterpipe(),h.win.trigger("resize"),w.cast.Flood(),w.cast.FloodFooter(),w.cast.NavSticky(),w.cast.Weather(),w.cast.City(),h.win.on("load",function(){t(".loadWrapper").animate({opacity:0},500,function(){t(this).hide()})})}),h.win.on("resize",function(){h.section.intro.css("min-height",h.win.outerHeight()),h.section.natur.css({height:h.win.outerHeight(),marginBottom:h.win.outerHeight()/2}),t(".weather").css("height",h.section.natur.outerHeight()),t(".waterpipe").each(function(e,n){t(n).css("height",c(v.iconPositionsArr.mainIcons[e],v.iconPositionsArr.mainIcons[e+1]))}),s(),o(),i()}),h.win.on("resize scroll",function(){l()})}(jQuery,d3,window,document);